{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upgrade Your Plan | TopSoftware</title>
  <meta name="description" content="Upgrade your plan with TopSoftware.">

  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap">
  <!-- Added Roboto for improved professional typography in the payment section -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
  
  <link rel="stylesheet" href="{% static 'payments.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="{% static 'navbar.css' %}">
  <script src="{% static 'navbar.js' %}"></script>
  
  <style>
    /* Navbar Styling */
    nav.navbar {
      background-color: #000 !important;
      padding: 10px 20px !important;
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000 !important;
      font-family: 'Montserrat', sans-serif !important;
    }
    html, body {
      margin: 0;
      padding: 0;
      background-color: #000;
      color: #fff;
    }
    /* Hide desktop navigation on mobile devices using a specific selector */
    @media (max-width: 768px) {
      nav.navbar ul.desktop-nav {
        display: none !important;
      }
    }
    
    /* Payment Section Container */
    #payment-section .container {
      max-width: 960px;
      margin: 0 auto;
      padding-left: 20px;
      padding-right: 20px;
    }
    #payment-section .card {
      background-color: #fff !important;
      color: #000 !important;
    }
    html, body {
      margin: 0;
      padding: 0;
      background-color: #000 !important;
      color: #fff !important;
    }
    /* Payment Section Text Enhancements */
    #payment-section .card .heading {
      font-family: 'Roboto', sans-serif;
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 0.5rem;
    }
    #payment-section .card .text,
    #payment-section .card label {
      font-family: 'Roboto', sans-serif;
      font-size: 1rem;
      font-weight: 500;
    }
  </style>
</head>
<body>
  {% include 'navbar.html' %}

  <section id="payment-section" style="padding-top: 180px;">
    <div class="container mt-5 mb-5 d-flex justify-content-center">
      <div class="card p-5">
        <div>
          <h4 class="heading">Buy your website</h4>
          <p class="text">Please make the payment to get your website or app started.</p>
        </div>

        <!-- Page quantity inputs -->
        <div class="mt-3">
          <label for="quantity-premium" class="fw-bold">1-3 Pages ($250 each):</label>
          <input type="number" id="quantity-premium" class="form-control" value="0" min="0" />
        </div>
        <div class="mt-3">
          <label for="quantity-basic" class="fw-bold">4-7 Pages ($210 each):</label>
          <input type="number" id="quantity-basic" class="form-control" value="0" min="0" />
        </div>
        <div class="mt-3">
          <label for="quantity-starter" class="fw-bold">7+ Pages ($180 each):</label>
          <input type="number" id="quantity-starter" class="form-control" value="0" min="0" />
        </div>
        <div class="mt-3">
          <label for="quantity-starterpack" class="fw-bold">Starter Pack - Landing Page ($55):</label>
          <input type="number" id="quantity-starterpack" class="form-control" value="0" min="0" />
        </div>

        <!-- Custom amount toggle -->
        <div class="mt-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="custom-toggle" onchange="toggleCustomAmount()">
            <label class="form-check-label fw-bold" for="custom-toggle">I want to pay a custom amount</label>
          </div>
        </div>

        <!-- Custom amount input -->
        <div class="mt-3" id="custom-amount-section" style="display: none;">
          <label for="custom-amount" class="fw-bold">Enter custom amount ($):</label>
          <input type="number" id="custom-amount" class="form-control" placeholder="0.00" min="0" step="0.01" />
        </div>

        <!-- Additional info -->
        <div class="mt-4">
          <label for="additional-details" class="fw-bold">Additional Details:</label>
          <textarea id="additional-details" class="form-control" rows="3" placeholder="Enter any details..."></textarea>
        </div>

        <!-- Total amount -->
        <div class="mt-4">
          <h5>Total Amount: <span id="total-price">$0.00</span></h5>
        </div>

        <!-- PayPal Button -->
        <div id="paypal-button-container" class="mt-4"></div>
      </div>
    </div>
  </section>

  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=AdIOdwGbHBKpREd3SXfhvoXY214yqYYnRt0jExL97hutsewKrcnF-2CcIFUnqg7koC2iuPIFa0yzA7a_HERE&currency=USD"></script>

  <script>
    let totalAmount = 0;

    const premiumPrice = 25000;
    const basicPrice = 21000;
    const starterPrice = 18000;
    const starterPackPrice = 5500;

    document.addEventListener("DOMContentLoaded", async function () {
      // Attach onchange events
      ["quantity-premium", "quantity-basic", "quantity-starter", "quantity-starterpack", "custom-amount"]
        .forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener("change", updateTotal);
        });

      updateTotal();

      elements = stripe.elements();
      card = elements.create("card", {
        style: {
          base: {
            fontSize: "16px",
            color: "#32325d",
            "::placeholder": { color: "#aab7c4" }
          },
          invalid: {
            color: "#fa755a",
            iconColor: "#fa755a"
          }
        }
      });
      card.mount("#card-container");

      document.getElementById("pay-button").addEventListener("click", async () => {
        if (totalAmount === 0) {
          alert("Please select a plan or enter a custom amount.");
          return;
        }

        const { paymentMethod, error } = await stripe.createPaymentMethod({
          type: "card",
          card: card,
        });

        if (error) {
          alert("Payment failed: " + error.message);
          return;
        }

        const additionalDetails = document.getElementById("additional-details")?.value || "";

        const response = await fetch("/payments/process-payment/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify({
            payment_method_id: paymentMethod.id,
            amount: totalAmount,
            additionalDetails: additionalDetails
          })
        });

        const result = await response.json();

        if (result.status === "success") {
          alert("Payment successful! Payment ID: " + result.payment_intent_id);
        } else {
          alert("Payment failed: " + result.message);
        }
      });
    });

    function toggleCustomAmount() {
      const isCustom = document.getElementById("custom-toggle").checked;
      document.getElementById("custom-amount-section").style.display = isCustom ? "block" : "none";

      ["quantity-premium", "quantity-basic", "quantity-starter", "quantity-starterpack"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.disabled = isCustom;
      });

      updateTotal();
    }

    function updateTotal() {
      const isCustom = document.getElementById("custom-toggle").checked;
      if (isCustom) {
        const custom = parseFloat(document.getElementById("custom-amount").value || 0);
        totalAmount = custom;
      } else {
        const qPremium = parseInt(document.getElementById("quantity-premium")?.value || 0);
        const qBasic = parseInt(document.getElementById("quantity-basic")?.value || 0);
        const qStarter = parseInt(document.getElementById("quantity-starter")?.value || 0);
        const qStarterPack = parseInt(document.getElementById("quantity-starterpack")?.value || 0);

        totalAmount = (qPremium * premiumPrice) +
                      (qBasic * basicPrice) +
                      (qStarter * starterPrice) +
                      (qStarterPack * starterPackPrice);
      }

      const totalDisplay = document.getElementById("total-price");
      if (totalDisplay) {
        totalDisplay.innerText = `$${(totalAmount / 100).toFixed(2)}`;
      }
    }

    function getCSRFToken() {
      return document.cookie.split('; ')
        .find(row => row.trim().startsWith('csrftoken='))
        ?.split('=')[1] || '';
    }
  </script>
</body>
</html>
