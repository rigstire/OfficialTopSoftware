{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upgrade Your Plan | TopSoftware</title>
  <meta name="description" content="Upgrade your plan with TopSoftware.">

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap">
  <link rel="stylesheet" href="{% static 'payments.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <link rel="stylesheet" href="{% static 'navbar.css' %}">
  <script src="{% static 'navbar.js' %}"></script>

  <style>
    nav.navbar {
      background-color: #000 !important;
      padding: 10px 20px !important;
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000 !important;
      font-family: 'Montserrat', sans-serif !important;
    }
    nav.navbar .navbar-container {
      width: 100% !important;
      max-width: 960px !important;
      margin: 0 auto !important;
      padding: 0 !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    nav.navbar .navbar-brand {
      color: #fff !important;
      font-size: 1.5rem !important;
      text-decoration: none !important;
      font-weight: 400 !important;
      padding-left: 20px;
    }
    nav.navbar .navbar-menu {
      list-style: none !important;
      display: flex !important;
      gap: 20px !important;
      margin: 0 !important;
      padding-right: 20px;
    }
    nav.navbar .navbar-menu li a {
      color: #fff !important;
      text-decoration: none !important;
      font-size: 1rem !important;
      font-weight: 400 !important;
    }
    .mobile-menu-icon {
      font-size: 1.8rem !important;
      cursor: pointer !important;
    }
    #payment-section .container {
      max-width: 960px;
      margin: 0 auto;
      padding-left: 20px;
      padding-right: 20px;
    }
    #payment-section .card {
      background-color: #fff !important;
      color: #000 !important;
    }
    html, body {
      margin: 0;
      padding: 0;
      background-color: #000 !important;
      color: #fff !important;
    }
  </style>
</head>
<body>
  {% include 'navbar.html' %}

  <section id="payment-section" style="padding-top: 180px;">
    <div class="container mt-5 mb-5 d-flex justify-content-center">
      <div class="card p-5">
        <div>
          <h4 class="heading">Upgrade your plan</h4>
          <p class="text">Please make the payment to start enjoying all the features of our premium plan.</p>
        </div>

        <!-- Product Listings (same as before) -->
        <!-- Quantity Inputs (same as before) -->
        <!-- Starter Pack + Custom Amount (same as before) -->
        <!-- Additional Details Textarea -->
        <!-- Total Amount Display -->
        <!-- ... all that unchanged content ... -->

        <!-- Card Section using Stripe -->
        <div class="mt-3">
          <label for="additional-details" class="fw-bold">Additional Details (e.g., website ideas, company name):</label>
          <textarea id="additional-details" class="form-control" rows="3" placeholder="Enter any details for your website..."></textarea>
        </div>

        <div class="mt-3">
          <h5>Total Amount: <span id="total-price">$0.00</span></h5>
        </div>

        <!-- ✅ Stripe Payment Form -->
        <div id="payment-form" class="mt-4">
          <label>Card Details</label>
          <div id="card-container" class="form-control p-3"></div>
        </div>

        <button id="pay-button" class="btn btn-primary btn-block payment-button mt-4">
          Proceed to Payment <i class="fa fa-long-arrow-right"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- ✅ Stripe.js -->
  <script src="https://js.stripe.com/v3/"></script>

  <script>
    const stripe = Stripe("pk_live_51R8nzUFmdWMt7ncCWok620uUkYIRDOYJkjYgZ1IPm7JPY4qUwMPeFVWp1ZSFQ680yxZpo6x3HGUh03a0TURSpGzMOOGSKfsXIf"); // Replace with your Stripe publishable key
    let stripeElements, cardElement;
    const premiumPrice = 25000;
    const basicPrice = 21000;
    const starterPrice = 18000;
    const starterPackPrice = 5500;
    let totalAmount = 0;

    document.addEventListener("DOMContentLoaded", function () {
      updateTotal();
      initializeStripe();
    });

    function updateTotal() {
      let quantityPremium = parseInt(document.getElementById("quantity-premium").value) || 0;
      let quantityBasic = parseInt(document.getElementById("quantity-basic").value) || 0;
      let quantityStarter = parseInt(document.getElementById("quantity-starter").value) || 0;
      let quantityStarterPack = parseInt(document.getElementById("quantity-starterpack").value) || 0;
      let customAmountInput = parseFloat(document.getElementById("custom-amount")?.value || 0) || 0;

      let computedTotal = (quantityPremium * premiumPrice) +
                          (quantityBasic * basicPrice) +
                          (quantityStarter * starterPrice) +
                          (quantityStarterPack * starterPackPrice);

      totalAmount = customAmountInput > 0 ? Math.round(customAmountInput * 100) : computedTotal;
      document.getElementById("total-price").innerText = `$${(totalAmount / 100).toFixed(2)}`;
    }

    function initializeStripe() {
      stripeElements = stripe.elements();
      cardElement = stripeElements.create('card');
      cardElement.mount('#card-container');

      document.getElementById("pay-button").addEventListener("click", async () => {
        if (totalAmount === 0) {
          alert("Please select at least one item or enter a custom amount.");
          return;
        }

        const { paymentMethod, error } = await stripe.createPaymentMethod({
          type: 'card',
          card: cardElement,
        });

        if (error) {
          console.error("Stripe Payment Error:", error);
          alert("Payment failed: " + error.message);
          return;
        }

        const additionalDetails = document.getElementById("additional-details").value;

        const response = await fetch("/payments/process-payment/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify({
            payment_method_id: paymentMethod.id,
            amount: totalAmount,
            additionalDetails: additionalDetails
          })
        });

        const data = await response.json();
        if (data.status === "success") {
          alert("Payment Successful! Payment Intent ID: " + data.payment_intent_id);
        } else {
          alert("Payment failed: " + data.message);
        }
      });
    }

    function getCSRFToken() {
      return document.cookie.split('; ')
          .find(row => row.startsWith('csrftoken='))
          ?.split('=')[1] || '';
    }
  </script>
</body>
</html>
