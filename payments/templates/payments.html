{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upgrade Your Plan | TopSoftware</title>
  <meta name="description" content="Upgrade your plan with TopSoftware.">

  <!-- Google Fonts: Montserrat -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap">

  <!-- Payment Page Specific Styles -->
  <link rel="stylesheet" href="{% static 'payments.css' %}">

  <!-- ✅ Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css">
  <!-- ✅ Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- ✅ jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <!-- Shared Navbar Assets (loaded last) -->
  <link rel="stylesheet" href="{% static 'navbar.css' %}">
  <script src="{% static 'navbar.js' %}"></script>

  <!-- Extra Navbar Override to Force Alignment -->
  <style>
    /* Make navbar fixed full width with proper left/right spacing */
    nav.navbar {
      background-color: #000 !important;
      padding: 10px 20px !important;
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100%;
      z-index: 1000 !important;
      font-family: 'Montserrat', sans-serif !important;
    }
    /* Force the navbar container to match the desired width */
    nav.navbar .navbar-container {
      width: 100% !important;
      max-width: 960px !important;
      margin: 0 auto !important;
      padding: 0 !important;
      display: flex !important;
      justify-content: space-between !important;
      align-items: center !important;
    }
    /* Force the brand to be flush left */
    nav.navbar .navbar-brand {
      color: #fff !important;
      font-size: 1.5rem !important;
      text-decoration: none !important;
      font-weight: 400 !important;
      padding-left: 20px; /* Adjust if needed */
    }
    /* Force the menu links to have right padding */
    nav.navbar .navbar-menu {
      list-style: none !important;
      display: flex !important;
      gap: 20px !important;
      margin: 0 !important;
      padding-right: 20px; /* Adjust if needed */
    }
    nav.navbar .navbar-menu li a {
      color: #fff !important;
      text-decoration: none !important;
      font-size: 1rem !important;
      font-weight: 400 !important;
    }
    .mobile-menu-icon {
      font-size: 1.8rem !important;
      cursor: pointer !important;
    }
  </style>

  <!-- Container override for payment content -->
  <style>
    /* Ensure payment content container matches navbar container */
    #payment-section .container {
      max-width: 960px;
      margin: 0 auto;
      padding-left: 20px;
      padding-right: 20px;
    }
    /* Ensure the payment card has a white background with black text */
    #payment-section .card {
      background-color: #fff !important;
      color: #000 !important;
    }
    /* Reset body margins/padding so our container is the reference */
    html, body {
      margin: 0;
      padding: 0;
      background-color: #000 !important;
      color: #fff !important;
    }
  </style>
</head>
<body>
  {% include 'navbar.html' %}

  <!-- Payment Content Section with top padding so it doesn't overlap the fixed navbar -->
  <section id="payment-section" style="padding-top: 180px;">
    <div class="container mt-5 mb-5 d-flex justify-content-center">
      <div class="card p-5">
        <div>
          <h4 class="heading">Upgrade your plan</h4>
          <p class="text">Please make the payment to start enjoying all the features of our premium plan.</p>
        </div>

        <!-- Product 1: Premium Subscription ($250) -->
        <div class="pricing p-3 rounded mt-4 d-flex justify-content-between align-items-center">
          <div class="images d-flex flex-row align-items-center">
            <img src="https://i.imgur.com/S17BrTx.png" class="rounded" width="60">
            <div class="d-flex flex-column ms-4">
              <span class="business">1-3 PAGES</span>
              <span class="plan">CHANGE PLAN</span>
            </div>
          </div>
          <div class="d-flex flex-row align-items-center">
            <sup class="dollar fw-bold">$</sup>
            <span class="amount mx-1">250</span>
            <span class="year fw-bold">/ each</span>
          </div>
        </div>

        <!-- Quantity Selection for Premium Subscription -->
        <div class="mt-3">
          <label for="quantity-premium" class="fw-bold">Select Quantity:</label>
          <input type="number" id="quantity-premium" class="form-control" value="0" min="0" max="10" onchange="updateTotal()">
        </div>

        <!-- Product 2: Basic Subscription ($210) -->
        <div class="pricing p-3 rounded mt-4 d-flex justify-content-between align-items-center">
          <div class="images d-flex flex-row align-items-center">
            <img src="https://i.imgur.com/S17BrTx.png" class="rounded" width="60">
            <div class="d-flex flex-column ms-4">
              <span class="business">4-7 PAGES</span>
              <span class="plan">CHANGE PLAN</span>
            </div>
          </div>
          <div class="d-flex flex-row align-items-center">
            <sup class="dollar fw-bold">$</sup>
            <span class="amount mx-1">210</span>
            <span class="year fw-bold">/ each</span>
          </div>
        </div>

        <!-- Quantity Selection for Basic Subscription -->
        <div class="mt-3">
          <label for="quantity-basic" class="fw-bold">Select Quantity:</label>
          <input type="number" id="quantity-basic" class="form-control" value="0" min="0" max="10" onchange="updateTotal()">
        </div>

        <!-- Product 3: Starter Subscription ($180) -->
        <div class="pricing p-3 rounded mt-4 d-flex justify-content-between align-items-center">
          <div class="images d-flex flex-row align-items-center">
            <img src="https://i.imgur.com/S17BrTx.png" class="rounded" width="60">
            <div class="d-flex flex-column ms-4">
              <span class="business">7+ PAGES</span>
              <span class="plan">CHANGE PLAN</span>
            </div>
          </div>
          <div class="d-flex flex-row align-items-center">
            <sup class="dollar fw-bold">$</sup>
            <span class="amount mx-1">180</span>
            <span class="year fw-bold">/ each</span>
          </div>
        </div>

        <!-- Quantity Selection for Starter Subscription -->
        <div class="mt-3">
          <label for="quantity-starter" class="fw-bold">Select Quantity:</label>
          <input type="number" id="quantity-starter" class="form-control" value="0" min="0" max="10" onchange="updateTotal()">
        </div>

        <!-- Product 4: Starter Pack ($55) -->
        <div class="pricing p-3 rounded mt-4 d-flex justify-content-between align-items-center">
          <div class="images d-flex flex-row align-items-center">
            <img src="https://i.imgur.com/S17BrTx.png" class="rounded" width="60">
            <div class="d-flex flex-column ms-4">
              <span class="business">Starter Pack</span>
              <span class="plan">Customized Landing Page</span>
            </div>
          </div>
          <div class="d-flex flex-row align-items-center">
            <sup class="dollar fw-bold">$</sup>
            <span class="amount mx-1">55</span>
          </div>
        </div>

        <!-- Quantity Selection for Starter Pack -->
        <div class="mt-3">
          <label for="quantity-starterpack" class="fw-bold">Select Quantity (Starter Pack):</label>
          <input type="number" id="quantity-starterpack" class="form-control" value="0" min="0" max="10" onchange="updateTotal()">
        </div>

        <!-- Custom Amount Option -->
        <div class="mt-3">
          <label for="custom-amount" class="fw-bold">Or enter a custom amount (in $):</label>
          <input type="number" id="custom-amount" class="form-control" placeholder="0.00" min="0" step="0.01" onchange="updateTotal()">
        </div>

        <!-- Separate the Additional Details section -->
        <hr class="my-4">

        <!-- Additional Details for the Website -->
        <div class="mt-3">
          <label for="additional-details" class="fw-bold">Additional Details (e.g., website ideas, company name):</label>
          <textarea id="additional-details" class="form-control" rows="3" placeholder="Enter any details for your website..."></textarea>
        </div>

        <!-- Total Amount -->
        <div class="mt-3">
          <h5>Total Amount: <span id="total-price">$0.00</span></h5>
        </div>

        <!-- ✅ Square Payment Form -->
        <div id="payment-form" class="mt-4">
          <label>Card Number</label>
          <div id="card-container"></div>
        </div>

        <button id="pay-button" class="btn btn-primary btn-block payment-button mt-4">
          Proceed to Payment <i class="fa fa-long-arrow-right"></i>
        </button>
      </div>
    </div>
  </section>

  <!-- ✅ Bootstrap Bundle JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>

  <script>
    const premiumPrice = 25000;  
    const basicPrice = 21000;  
    const starterPrice = 18000;  
    const starterPackPrice = 5500;  
    let totalAmount = 0;

    document.addEventListener("DOMContentLoaded", function() {
      initializeSquare();
    });

    function updateTotal() {
      let quantityPremium = parseInt(document.getElementById("quantity-premium").value) || 0;
      let quantityBasic = parseInt(document.getElementById("quantity-basic").value) || 0;
      let quantityStarter = parseInt(document.getElementById("quantity-starter").value) || 0;
      let quantityStarterPack = parseInt(document.getElementById("quantity-starterpack").value) || 0;
      let customAmountInput = parseFloat(document.getElementById("custom-amount") ? document.getElementById("custom-amount").value : 0) || 0;

      let computedTotal = (quantityPremium * premiumPrice) + 
                          (quantityBasic * basicPrice) + 
                          (quantityStarter * starterPrice) + 
                          (quantityStarterPack * starterPackPrice);

      if (customAmountInput > 0) {
          totalAmount = Math.round(customAmountInput * 100); // Convert dollars to cents
      } else {
          totalAmount = computedTotal;
      }

      document.getElementById("total-price").innerText = `$${(totalAmount / 100).toFixed(2)}`;
    }

    async function initializeSquare() {
      if (!window.Square) {
          alert("Failed to load Square payment form. Please refresh the page.");
          return;
      }

      try {
          const payments = Square.payments("sq0idp-d7q5R7FhiIQyCwy6y5eU9Q", "L539FECXHJ9E1");
          const card = await payments.card();
          await card.attach('#card-container');

          document.getElementById("pay-button").addEventListener("click", async () => {
              if (totalAmount === 0) {
                  alert("Please select at least one item or enter a custom amount.");
                  return;
              }

              const result = await card.tokenize();
              if (result.status === "OK") {
                  processPayment(result.token);
              } else {
                  console.error("Payment tokenization failed:", result.errors);
                  alert("Payment failed. Please try again.");
              }
          });

      } catch (e) {
          console.error("Error initializing Square:", e);
          alert("Failed to load payment form. Check the console for details.");
      }
    }

    async function processPayment(nonce) {
      const additionalDetails = document.getElementById("additional-details").value;
      const response = await fetch("/payments/process-payment/", {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-CSRFToken": getCSRFToken()
          },
          body: JSON.stringify({ sourceId: nonce, amount: totalAmount, additionalDetails: additionalDetails })
      });

      const data = await response.json();
      if (data.status === "success") {
          alert("Payment Successful! Payment ID: " + data.payment_id);
      } else {
          alert("Payment failed: " + data.message);
      }
    }

    function getCSRFToken() {
      return document.cookie.split('; ')
          .find(row => row.startsWith('csrftoken='))
          ?.split('=')[1] || '';
    }
  </script>
</body>
</html>
