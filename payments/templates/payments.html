<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Purchase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a56d4;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --error-color: #dc3545;
            --success-color: #28a745;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--dark-color);
            background-color: #f5f7ff;
            padding: 20px;
        }

        .payment-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .payment-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
        }

        .payment-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .payment-title {
            color: var(--primary-color);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .payment-subtitle {
            color: #6c757d;
            font-size: 1rem;
        }

        .order-summary {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .summary-row.total {
            font-weight: bold;
            font-size: 1.1rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #dee2e6;
        }

        #paypal-button-container {
            margin: 1.5rem 0;
            min-height: 45px;
        }

        .secure-note {
            text-align: center;
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .secure-note i {
            color: var(--primary-color);
            margin-right: 0.5rem;
        }

        .error-message {
            color: var(--error-color);
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 0.75rem 1.25rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            display: none;
        }

        @media (max-width: 768px) {
            .payment-card {
                padding: 1.5rem;
            }
            
            .payment-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-card">
            <div class="payment-header">
                <h2 class="payment-title">Complete Your Purchase</h2>
                <p class="payment-subtitle">Secure payment processed through PayPal</p>
            </div>

            <!-- Order Summary -->
            <div class="order-summary">
                <h3>Order Summary</h3>
                <div class="summary-row">
                    <span>Subtotal:</span>
                    <span id="subtotal-price">$0.00</span>
                </div>
                <div class="summary-row">
                    <span>Tax:</span>
                    <span>$0.00</span>
                </div>
                <div class="summary-row total">
                    <span>Total:</span>
                    <span id="total-price">$0.00</span>
                </div>
            </div>

            <!-- Payment Method -->
            <div id="payment-method">
                <h3>Payment Method</h3>
                <div id="paypal-button-container"></div>
                <div id="payment-errors" class="error-message"></div>
                <p class="secure-note"><i class="fas fa-lock"></i> Secure credit card and PayPal payment</p>
            </div>
        </div>
    </div>

    <!-- PayPal SDK -->
    <script src="https://www.paypal.com/sdk/js?client-id=AZzKmi-sF1eEx060yoNw_emy5Og34KwAAw_Wrd1t7f5wT0JtZlA7DI6fbNgVoaSuTp8nK-aF9zPRjsxz&currency=USD"></script>
    
    <script>
        // Set your total amount (in cents for precision)
        let totalAmount = 0;
        
        // Sample pricing - update with your actual pricing logic
        const premiumPrice = 250;
        const basicPrice = 210;
        const starterPrice = 180;
        
        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial total
            updateTotal();
            
            // Initialize PayPal Buttons
            initPayPal();
        });

        // Initialize PayPal Buttons with Guest Checkout
        function initPayPal() {
            paypal.Buttons({
                style: {
                    layout: 'vertical',
                    color: 'blue',
                    shape: 'rect',
                    label: 'checkout',  // This enables guest checkout
                    height: 45,
                    tagline: false
                },

                createOrder: function(data, actions) {
                    if (totalAmount === 0) {
                        showError('Please select a plan or enter an amount');
                        throw new Error('Amount cannot be zero');
                    }
                    
                    if (totalAmount < 100) { // Minimum $1.00
                        showError('Minimum payment amount is $1.00');
                        throw new Error('Minimum amount not met');
                    }

                    return fetch('/create_order/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            amount: (totalAmount / 100).toFixed(2)
                        })
                    })
                    .then(function(res) {
                        if (!res.ok) {
                            return res.json().then(err => { throw new Error(err.error || 'Failed to create order'); });
                        }
                        return res.json();
                    })
                    .then(function(data) {
                        if (!data.orderID) throw new Error('No order ID received');
                        return data.orderID;
                    });
                },

                onApprove: function(data, actions) {
                    return actions.order.capture().then(function(details) {
                        // On successful payment
                        console.log('Payment completed:', details);
                        window.location.href = '/payment/success/';
                    });
                },

                onError: function(err) {
                    console.error('PayPal error:', err);
                    showError(err.message || 'Payment failed. Please try again.');
                },

                onCancel: function(data) {
                    console.log('Payment canceled');
                    showError('Payment was canceled');
                }

            }).render('#paypal-button-container');
        }

        // Update total amount
        function updateTotal() {
            // Example calculation - replace with your actual logic
            const qPremium = parseInt(document.getElementById('quantity-premium')?.value || 0);
            const qBasic = parseInt(document.getElementById('quantity-basic')?.value || 0);
            const qStarter = parseInt(document.getElementById('quantity-starter')?.value || 0);
            
            totalAmount = (qPremium * premiumPrice) + (qBasic * basicPrice) + (qStarter * starterPrice);
            
            document.getElementById('subtotal-price').textContent = `$${(totalAmount / 100).toFixed(2)}`;
            document.getElementById('total-price').textContent = `$${(totalAmount / 100).toFixed(2)}`;
        }

        // Show error message
        function showError(message) {
            const errorElement = document.getElementById('payment-errors');
            errorElement.style.display = 'block';
            errorElement.textContent = message;
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>
</html>